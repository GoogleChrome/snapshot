'use strict';function __awaiter(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b)).next())})}const DB_VERSION=2;class ImageDB{constructor(){const a=indexedDB.open('image-db',DB_VERSION);this.dbPromise=new Promise((b,c)=>{this.dbResolve=b,this.dbReject=c,a.onerror=(a)=>this.dbReject(a),a.onupgradeneeded=(a)=>this.createObjectStore(a),a.onsuccess=()=>this.dbOpened(a)})}store(a){const b=new Promise((b,c)=>{this.dbPromise.then((d)=>{const e=d.transaction(['images'],'readwrite'),f=e.objectStore('images').put(a);f.onsuccess=()=>b(f.result),f.onerror=c}).catch(c)});return b}retrieve(a){const b=new Promise((b,c)=>{this.dbPromise.then((d)=>{const e=d.transaction(['images'],IDBTransaction.READ_ONLY),f=e.objectStore('images').get(a);f.onsuccess=()=>b(f.result),f.onerror=c}).catch(c)});return b}all(){const a=new Promise((a,b)=>{this.dbPromise.then((c)=>{const d=c.transaction(['images'],IDBTransaction.READ_ONLY),e=d.objectStore('images').openCursor(),f=[];e.onsuccess=()=>{const b=e.result;b?(f.push(b.value),b.continue()):a(f)},e.onerror=b}).catch(b)});return a}dbOpened(a){this.dbResolve(a.result),this.dbPromise.then((a)=>{a.onerror=(a)=>this.error(a)})}error(a){console.error(a)}createObjectStore(a){const b=a.target,c=b.result;switch(a.oldVersion){case 1:c.deleteObjectStore('images');case 0:c.createObjectStore('images',{keyPath:'id',autoIncrement:!0});}}}var db=new ImageDB;class ViewState{}class View{constructor(a){this.viewElement=a}show(){this.viewElement.classList.remove('hidden')}hide(){this.viewElement.classList.add('hidden')}getState(){return this.state||new ViewState}setState(a){this.state=a}}class BrowseView extends View{constructor(){super(document.getElementById('browse-view')),this.captureButton=document.getElementById('browse-capture-button'),this.emptyListElement=document.getElementById('empty-browse-list'),this.listElement=document.getElementById('browse-list'),this.captureButton.addEventListener('click',()=>this.capture()),this.blobURLs=new Set}show(){const a=(a)=>super[a];return __awaiter(this,void 0,void 0,function*(){const b=yield db.all();if(0===b.length)this.emptyListElement.classList.remove('hidden'),this.listElement.classList.add('hidden');else{this.emptyListElement.classList.add('hidden'),this.listElement.classList.remove('hidden');for(const a of b){const b=document.createElement('div');b.classList.add('element'),b.addEventListener('click',()=>router.visit(`/image/${a.id}`));const c=a.edited||a.original;if(c){const a=URL.createObjectURL(c);this.blobURLs.add(a),b.style.backgroundImage=`url(${a})`}this.listElement.appendChild(b)}}a('show').call(this)})}hide(){for(super.hide();this.listElement.hasChildNodes();)this.listElement.removeChild(this.listElement.lastChild);for(const a of this.blobURLs)URL.revokeObjectURL(a);this.blobURLs.clear()}capture(){router.visit('/capture')}}class ImageRecord{constructor(a){this.original=a,this.edited=null}}const streamConstraints={audio:!1,video:{deviceId:'',facingMode:['user','environment'],height:{ideal:1080},width:{ideal:1920}}};class CaptureView extends View{constructor(){super(document.getElementById('capture-view')),this.videoElement=this.viewElement.querySelector('video#preview'),this.videoElement2=this.viewElement.querySelector('video#preview2'),this.takePhotoButton=document.getElementById('capture-button'),this.cameraChooseButton=document.getElementById('camera-choose-button'),this.mirrorButton=document.getElementById('capture-mirror-button'),this.closeButton=document.getElementById('capture-view-close'),this.videoElement2.classList.add('hidden'),this.takePhotoButton.addEventListener('click',()=>this.takePhoto()),this.cameraChooseButton.addEventListener('click',()=>this.toggleCameraChooser()),this.mirrorButton.addEventListener('click',()=>this.toggleMirror()),this.closeButton.addEventListener('click',()=>this.close()),this.devicesPromise=this.getDevices(),this.currentDevice=null}show(){this.devicesPromise.then((a)=>{this.currentDevice=a[0],this.startStream(a[0].deviceId)}),super.show()}hide(){this.capture&&this.capture.track.stop(),this.videoElement.pause(),super.hide()}getDevices(){return __awaiter(this,void 0,void 0,function*(){let a=yield navigator.mediaDevices.enumerateDevices();return a=a.filter((a)=>'videoinput'===a.kind),2>a.length?this.cameraChooseButton.classList.add('hidden'):this.cameraChooseButton.classList.remove('hidden'),a})}takePhoto(){if(this.capture)this.capture.takePhoto().then((a)=>this.storeResult(a));else{const a=document.createElement('canvas'),b=a.getContext('2d');a.width=this.videoElement.videoWidth,a.height=this.videoElement.videoHeight,b.drawImage(this.videoElement,0,0),a.toBlob((a)=>this.storeResult(a),'image/jpg')}}toggleCameraChooser(){return __awaiter(this,void 0,void 0,function*(){const a=yield this.devicesPromise;if(!(2>a.length)){if(this.currentDevice){const b=a.indexOf(this.currentDevice);this.currentDevice=a[(b+1)%a.length]}else this.currentDevice=a[0];this.startStream(this.currentDevice.deviceId)}})}close(){router.visit(`/browse`)}storeResult(a){const b=new ImageRecord(a);db.store(b).then((a)=>router.visit(`/image/${a}`))}stopStream(a){if(a)for(const b of a.getVideoTracks())b.stop()}startStream(a){const b=this.videoElement.srcObject;b&&this.stopStream(b),streamConstraints.video.deviceId=a,navigator.mediaDevices.getUserMedia(streamConstraints).then((a)=>{if(this.videoElement2.srcObject=a,this.videoElement2.onloadedmetadata=()=>{const a=this.videoElement;this.videoElement=this.videoElement2,this.videoElement2=a,this.videoElement.play(),this.videoElement.classList.remove('hidden'),this.videoElement2.classList.add('hidden'),this.videoElement2.pause()},'ImageCapture'in window){const b=a.getVideoTracks()[0];this.capture=new ImageCapture(b)}})}toggleMirror(){this.videoElement.classList.contains('mirror')?this.videoElement.classList.remove('mirror'):this.videoElement.classList.add('mirror')}}var fragmentShader='\nprecision highp float;\nvarying vec2 texCoords;\nuniform sampler2D textureSampler;\nuniform vec2 sourceSize;\nuniform float saturation;\nuniform float warmth;\nuniform float sharpen;\nuniform float brightness;\nuniform float contrast;\nuniform float blur;\nuniform float vignette;\nuniform float grey;\nvec3 saturationVector = vec3(0.299, 0.587, 0.114);\nvoid main() {\n  vec2 off = sourceSize * blur;\n  vec2 off2 = off * 2.0;\n  vec4 tex00 = texture2D(textureSampler, texCoords + vec2(-off2.x, -off2.y));\n  vec4 tex10 = texture2D(textureSampler, texCoords + vec2(-off.x, -off2.y));\n  vec4 tex20 = texture2D(textureSampler, texCoords + vec2(0.0, -off2.y));\n  vec4 tex30 = texture2D(textureSampler, texCoords + vec2(off.x, -off2.y));\n  vec4 tex40 = texture2D(textureSampler, texCoords + vec2(off2.x, -off2.y));\n  vec4 tex01 = texture2D(textureSampler, texCoords + vec2(-off2.x, -off.y));\n  vec4 tex11 = texture2D(textureSampler, texCoords + vec2(-off.x, -off.y));\n  vec4 tex21 = texture2D(textureSampler, texCoords + vec2(0.0, -off.y));\n  vec4 tex31 = texture2D(textureSampler, texCoords + vec2(off.x, -off.y));\n  vec4 tex41 = texture2D(textureSampler, texCoords + vec2(off2.x, -off.y));\n  vec4 tex02 = texture2D(textureSampler, texCoords + vec2(-off2.x, 0.0));\n  vec4 tex12 = texture2D(textureSampler, texCoords + vec2(-off.x, 0.0));\n  vec4 tex22 = texture2D(textureSampler, texCoords + vec2(0.0, 0.0));\n  vec4 tex32 = texture2D(textureSampler, texCoords + vec2(off.x, 0.0));\n  vec4 tex42 = texture2D(textureSampler, texCoords + vec2(off2.x, 0.0));\n  vec4 tex03 = texture2D(textureSampler, texCoords + vec2(-off2.x, off.y));\n  vec4 tex13 = texture2D(textureSampler, texCoords + vec2(-off.x, off.y));\n  vec4 tex23 = texture2D(textureSampler, texCoords + vec2(0.0, off.y));\n  vec4 tex33 = texture2D(textureSampler, texCoords + vec2(off.x, off.y));\n  vec4 tex43 = texture2D(textureSampler, texCoords + vec2(off2.x, off.y));\n  vec4 tex04 = texture2D(textureSampler, texCoords + vec2(-off2.x, off2.y));\n  vec4 tex14 = texture2D(textureSampler, texCoords + vec2(-off.x, off2.y));\n  vec4 tex24 = texture2D(textureSampler, texCoords + vec2(0.0, off2.y));\n  vec4 tex34 = texture2D(textureSampler, texCoords + vec2(off.x, off2.y));\n  vec4 tex44 = texture2D(textureSampler, texCoords + vec2(off2.x, off2.y));\n  vec4 tex = tex22;\n  vec4 blurred = 1.0 * tex00 + 4.0 * tex10 + 6.0 * tex20 + 4.0 * tex30 + 1.0 * tex40\n               + 4.0 * tex01 + 16.0 * tex11 + 24.0 * tex21 + 16.0 * tex31 + 4.0 * tex41\n               + 6.0 * tex02 + 24.0 * tex12 + 36.0 * tex22 + 24.0 * tex32 + 6.0 * tex42\n               + 4.0 * tex03 + 16.0 * tex13 + 24.0 * tex23 + 16.0 * tex33 + 4.0 * tex43\n               + 1.0 * tex04 + 4.0 * tex14 + 6.0 * tex24 + 4.0 * tex34 + 1.0 * tex44;\n  blurred /= 256.0;\n  tex += (tex - blurred) * sharpen;\n  vec3 desaturated = vec3(dot(saturationVector, tex.rgb));\n  vec3 mixed = mix(desaturated, tex.rgb, saturation);\n  vec4 color = vec4(mixed, 1.0);\n  color.r += warmth;\n  color.b -= warmth;\n  vec4 gray = vec4(grey, grey, grey, 1.0);\n  color = mix(color * brightness, mix(gray, color, contrast), 0.5);\n  float ratio = off.x / off.y;\n  float dist = sqrt(pow(texCoords.x - 0.5, 2.0) + pow(ratio * (texCoords.y - 0.5), 2.0));\n  float vigCurve = 1.5 * exp(-pow(dist, 2.0) / (2.0 * pow(-vignette, 2.0)));\n  color *= vigCurve;\n  color.a = 1.0;\n  gl_FragColor = color;\n}\n';const BASE_VERTEX_SHADER=`
attribute vec2 position;
attribute vec2 uv;

varying vec2 texCoords;

void main() {
  gl_Position = vec4(position, 0, 1.0);
  texCoords = uv;
}`,BASE_FRAGMENT_SHADER=`
precision highp float;

varying vec2 texCoords;

uniform sampler2D textureSampler;

void main() {
  gl_FragColor = texture2D(textureSampler, texCoords);
}`,POSITIONS=new Float32Array([-1,-1,-1,1,1,1,1,-1]),UVS=new Float32Array([0,1,0,0,1,0,1,1]),INDEX=new Uint16Array([0,1,2,0,2,3]);class ImageShader{constructor(){this.canvas=document.createElement('canvas');const a=this.canvas.getContext('webgl');if(null===a)throw new Error(`Couldn't get a WebGL context`);const b=a;this.context=b;const c=b.createTexture();if(null===c)throw new Error('Error getting texture ID');this.textureId=c,this.programId=0,this.vertShader=BASE_VERTEX_SHADER,this.fragShader=BASE_FRAGMENT_SHADER,this.uniformLocations=new Map,this.createVAO(INDEX,POSITIONS,UVS),b.clearColor(1,1,1,1),this.dirtyProgram=!0}setImage(a){const b=this.context;b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.textureId),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR)}setVertexShader(a){this.vertShader=a,this.dirtyProgram=!0}setFragmentShader(a){this.fragShader=a,this.dirtyProgram=!0}setUniform(a,b){const c=this.context;if(this.dirtyProgram&&this.createProgram(),!this.uniformLocations.has(a))return void console.warn(`Tried to set unknown uniform ${a}`);const d=this.uniformLocations.get(a);switch(d.type){case c.FLOAT:c.uniform1fv(d.location,[b]);break;case c.FLOAT_VEC2:c.uniform2fv(d.location,b);break;case c.FLOAT_VEC3:c.uniform3fv(d.location,b);break;case c.FLOAT_VEC4:c.uniform4fv(d.location,b);break;case c.BOOL:case c.INT:c.uniform1iv(d.location,[b]);break;case c.BOOL_VEC2:case c.INT_VEC2:c.uniform2iv(d.location,b);break;case c.BOOL_VEC3:case c.INT_VEC3:c.uniform3iv(d.location,b);break;case c.BOOL_VEC4:case c.INT_VEC4:c.uniform4iv(d.location,b);break;default:console.error(`Couldn't set uniform, unsupported type`);}}render(){const a=this.context;this.dirtyProgram&&this.createProgram(),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0),a.flush()}createProgram(){const a=this.context,b=this.compileShader(this.vertShader,a.VERTEX_SHADER),c=this.compileShader(this.fragShader,a.FRAGMENT_SHADER),d=a.createProgram();if(null===d)throw new Error(`Couldn't get a program ID`);if(this.programId=d,a.attachShader(d,b),a.attachShader(d,c),a.linkProgram(d),!a.getProgramParameter(d,a.LINK_STATUS)){const b=a.getProgramInfoLog(d);throw new Error('Could not link shader program. \n\n'+b)}if(a.validateProgram(d),!a.getProgramParameter(d,a.VALIDATE_STATUS)){const b=a.getProgramInfoLog(d);throw new Error('Could not validate shader program. \n\n'+b)}a.useProgram(d),this.uniformLocations=new Map,this.getUniformLocations(),this.dirtyProgram=!1}compileShader(a,b){const c=this.context,d=c.createShader(b);if(null===d)throw new Error('Error creating shader');if(c.shaderSource(d,a),c.compileShader(d),!c.getShaderParameter(d,c.COMPILE_STATUS))throw new Error(`Couldn't compiler shader: ${c.getShaderInfoLog(d)}`);return d}getUniformLocations(){const a=this.context,b=a.getProgramParameter(this.programId,a.ACTIVE_UNIFORMS);for(let c=0;c<b;c++){const b=a.getActiveUniform(this.programId,c);if(null===b)throw new Error(`Couldn't get uniform info`);const d=a.getUniformLocation(this.programId,b.name);d&&this.uniformLocations.set(b.name,{type:b.type,location:d})}}createVAO(a,b,c){const d=this.context,e=d.getExtension('OES_vertex_array_object');if(!e)throw new Error(`Browser doesn't support VAOs`);const f=e.createVertexArrayOES();e.bindVertexArrayOES(f),this.bindIndicesBuffer(a),this.bindAttributeBuffer(0,2,b),this.bindAttributeBuffer(1,2,c),d.enableVertexAttribArray(0),d.enableVertexAttribArray(1)}bindAttributeBuffer(a,b,c){const d=this.context,e=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,e),d.bufferData(d.ARRAY_BUFFER,c,d.STATIC_DRAW),d.vertexAttribPointer(a,b,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,null)}bindIndicesBuffer(a){const b=this.context,c=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c),b.bufferData(b.ELEMENT_ARRAY_BUFFER,a,b.STATIC_DRAW)}}class EditView extends View{constructor(){super(document.getElementById('edit-view')),this.destElement=document.getElementById('edit-dest'),this.sliders=new Map;for(const a of[...this.viewElement.getElementsByTagName('input')])this.sliders.set(a.id,a),a.addEventListener('input',()=>{this.animationFrame||(this.animationFrame=requestAnimationFrame(()=>this.draw()))});this.imageShader=new ImageShader,this.imageShader.setFragmentShader(fragmentShader),this.destElement.appendChild(this.imageShader.canvas)}show(){const a=this.getState();if(!a.id)throw new Error(`Couldn't get id of image`);this.imageElement=document.createElement('img'),this.imageElement.onload=()=>{URL.revokeObjectURL(this.imageElement.src),this.imageShader.setImage(this.imageElement),this.animationFrame=requestAnimationFrame(()=>this.draw())},db.retrieve(a.id).then((a)=>{this.currentRecord=a,this.imageElement.src=URL.createObjectURL(a.original)}),super.show()}hide(){cancelAnimationFrame(this.animationFrame),this.animationFrame=0,super.hide()}getState(){const a=super.getState();a.sliderValues=new Map;for(const[b,c]of this.sliders)a.sliderValues.set(b,+c.value);return a}setState(a){for(const[b,c]of this.sliders)c.value=c.defaultValue;if(a.sliderValues)for(const[b,c]of a.sliderValues)this.sliders.has(b)&&(this.sliders.get(b).value=c+'');super.setState(a)}draw(){const a=this.imageShader.canvas;a.width=this.imageElement.naturalWidth,a.height=this.imageElement.naturalHeight,this.imageShader.setUniform('sourceSize',new Float32Array([1/a.width,1/a.height]));for(const[a,b]of this.sliders){const c=+b.value/50;this.imageShader.setUniform(a,c)}this.animationFrame=0,this.imageShader.render(),a.toBlob((a)=>{this.currentRecord.edited=a,db.store(this.currentRecord)})}}class ImageView extends View{constructor(){super(document.getElementById('image-view')),this.imageElement=document.getElementById('output-image'),this.editButton=document.getElementById('image-edit-button'),this.editButton.addEventListener('click',()=>this.edit())}show(){const a=this.getState();if(!a.id)throw new Error(`Couldn't get id of image`);this.imageElement.onload=()=>URL.revokeObjectURL(this.imageElement.src),db.retrieve(a.id).then((a)=>{const b=a.edited||a.original;this.imageElement.src=URL.createObjectURL(b)}),super.show()}edit(){const a=this.getState();if(!a.id)throw new Error(`Couldn't get id of image`);router.visit(`/edit/${a.id}`)}}class Router{constructor(){window.addEventListener('popstate',(a)=>this.changeHandler(a.state)),this.browseView=new BrowseView,this.captureView=new CaptureView,this.editView=new EditView,this.imageView=new ImageView}changeHandler(a){if(window.location.pathname===this.currentLocation)return;this.currentLocation=window.location.pathname;const b=this.currentLocation.split('/');this.currentView&&this.currentView.hide(),a||(a=new ViewState);let c=null;switch(b[1]){case'':case'capture':c=this.captureView;break;case'browse':c=this.browseView;break;case'edit':c=this.editView,a.id=+b[2];break;case'image':c=this.imageView,a.id=+b[2];break;default:console.log('404');}c?this.switch(c,a):console.log('Oh no, no view found!')}switch(a,b){this.currentView&&this.currentView.hide(),a.setState(b),a.show(),this.currentView=a}visit(a){if(window.location.href===a)return;let b;this.currentView&&(b=this.currentView.getState()),window.history.replaceState(b,'',window.location.href),window.history.pushState(null,'',a),this.changeHandler()}click(a){const b=a.target;a.metaKey||a.ctrlKey||0!==a.button||(a.preventDefault(),this.visit(b.href))}}var router=new Router;'serviceWorker'in navigator&&navigator.serviceWorker.register('/sw.js'),router.changeHandler();
